<!DOCTYPE html>
<html>
<head>
    <title>HomeYantric</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>
    <div id="offline-overlay" class="hidden">
        <div class="offline-card">
            <div class="spinner"></div>
            <div class="offline-text">Trying to reconnect...</div>
            <div id="offline-last-connected" class="offline-subtext"></div>
            <button id="offline-retry-btn" class="offline-retry">Retry now</button>
        </div>
    </div>
    <div id="main-container" class="container hidden">
        
        <!-- BRANDING HEADER -->
        <div class="hero-header">
            <div class="hero-core">
                <div class="hero-logo">
                    <svg viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg">
                      <rect x="5" y="5" width="110" height="70" rx="20" ry="20" fill="#3d4d24"/>
                      <path d="M25 20 V 60 M95 20 V 60 M25 40 H 95 M60 40 V 60" stroke="#cbd5c1" stroke-width="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="hero-title">
                    <h1 id="brand-title">
                        <span class="brand-line brand-home">Home</span>
                        <span class="brand-line brand-yantric">Yantric</span>
                    </h1>
                </div>
            </div>
            <div id="status-stack" class="status-stack">
                <div id="bed-status-pill" class="bed-status-chip" onclick="toggleBedSummary()">
                    <span id="bed-pill-dot" class="bed-pill-dot"></span>
                    <span id="bed-pill-status" class="bed-pill-status">OFF</span>
                    <span id="bed-pill-room" class="bed-pill-room"></span>
                    <span id="bed-sse-status" class="bed-sse-status" title="Live updates">LIVE</span>
                </div>
                <div id="light-status-pill" class="light-status-chip hidden">
                    <span id="light-pill-dot" class="light-pill-dot"></span>
                    <span id="light-pill-count" class="light-pill-count">Lights 0/0</span>
                    <span id="light-pill-rooms" class="light-pill-rooms">Rooms 0</span>
                    <span id="light-sse-status" class="bed-sse-status" title="Live updates">LIVE</span>
                </div>
                <div id="bed-settings-menu" class="bed-settings-menu">
                    <button class="bed-settings-btn" type="button" onclick="toggleSettingsMenu()" aria-label="Open settings menu">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="bed-settings-dropdown" class="bed-settings-dropdown">
                        <button type="button" onclick="openSetModal(['presets'], 'Presets')">
                            <span>Presets</span><i class="fas fa-sliders-h"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['look'], 'Look &amp; Feel')">
                            <span>Look &amp; Feel</span><i class="fas fa-palette"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['limits'], 'Travel Limits')">
                            <span>Travel Limits</span><i class="fas fa-ruler-vertical"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['debug'], 'Debug Logs')">
                            <span>Debug Logs</span><i class="fas fa-bug"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['labels'], 'Rename Device/Room')">
                            <span>Rename Device/Room</span><i class="fas fa-tag"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['ota'], 'Firmware Update')">
                            <span>Firmware Update</span><i class="fas fa-cloud-upload-alt"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['network'], 'Network')">
                            <span>Network</span><i class="fas fa-wifi"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['presets','look','limits','debug','labels','ota','network'], 'Settings')">
                            <span>All Settings</span><i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                <div id="light-settings-menu-top" class="light-settings-menu">
                    <button class="bed-settings-btn" type="button" onclick="toggleLightSettingsMenu()" aria-label="Open light settings menu">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="light-settings-dropdown" class="bed-settings-dropdown">
                        <button type="button" onclick="openSetModal(['wiring'], 'Analog Wiring')">
                            <span>Analog Wiring</span><i class="fas fa-project-diagram"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['look'], 'Look &amp; Feel')">
                            <span>Look &amp; Feel</span><i class="fas fa-palette"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['labels'], 'Rename Device/Room')">
                            <span>Rename Device/Room</span><i class="fas fa-tag"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['network'], 'Network')">
                            <span>Network</span><i class="fas fa-wifi"></i>
                        </button>
                        <button type="button" onclick="openSetModal(['wiring','look','labels','network'], 'Settings')">
                            <span>All Settings</span><i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-switch" class="tab-switch"></div>

        <div id="bed-tab" class="tab-panel active">
            <div id="bed-summary" class="light-card bed-summary-card">
                <div class="bed-summary-header">
                    <div class="bed-summary-title">
                        <h2>Bed</h2>
                        <div id="bed-summary-subtitle" class="bed-summary-subtitle">Summary</div>
                    </div>
                    <button id="bed-summary-toggle" class="bed-summary-toggle" type="button" aria-label="Toggle details" onclick="toggleBedSummary()">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="bed-summary-body">
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Target</span>
                        <span id="bed-summary-target" class="bed-summary-value">Unknown</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Room</span>
                        <span id="bed-summary-room" class="bed-summary-value">Unknown</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Host</span>
                        <span id="bed-summary-host" class="bed-summary-value">-</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Positions</span>
                        <span id="bed-summary-positions" class="bed-summary-value">Head 0s, Foot 0s</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Motion</span>
                        <span id="bed-summary-motion" class="bed-summary-value">Idle</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Uptime</span>
                        <span id="bed-summary-uptime" class="bed-summary-value">-</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Last seen</span>
                        <span id="bed-summary-last-seen" class="bed-summary-value">-</span>
                    </div>
                    <div class="bed-summary-row">
                        <span class="bed-summary-label">Firmware</span>
                        <span id="bed-summary-fw" class="bed-summary-value">-</span>
                    </div>
                </div>
            </div>
            <div class="status">
                <div class="svg-container">
                    <svg class="svg-visualizer" viewBox="0 0 350 164">
                        <polygon id="bed-top-1" class="bed-base" points=""></polygon>
                        <polygon id="bed-top-2" class="bed-base" points=""></polygon>
                        <polygon id="bed-top-3" class="bed-base" points=""></polygon>
                        <polygon id="bed-top-4" class="bed-base" points=""></polygon>
                        <polygon id="vanish-bed-base" class="bed-base" points=""></polygon>
                        <polygon id="bed-base" class="bed-base" points=""></polygon>
                        <polygon id="bed-top" class="bed-base" points=""></polygon>
                        <rect id="vanish-element-0" class="vanish-rect" x="0" y="108" width="118" height="16" rx="2" ry="2"></rect>
                        <rect id="vanish-element-1" class="vanish-rect" x="122" y="108" width="48" height="16" rx="2" ry="2"></rect>
                        <rect id="vanish-element-2" class="vanish-rect" x="174" y="108" width="86" height="16" rx="2" ry="2"></rect>
                        <rect id="vanish-element-3" class="vanish-rect" x="264" y="108" width="86" height="16" rx="2" ry="2"></rect>
                        <polygon id="vanish-top-0" class="vanish-top" points=""></polygon>
                        <polygon id="vanish-top-1" class="vanish-top" points=""></polygon>
                        <polygon id="vanish-top-2" class="vanish-top" points=""></polygon>
                        <polygon id="vanish-top-3" class="vanish-top" points=""></polygon>
                        <line id="vanish-connector-0" class="vanish-connector" x1="0" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-1" class="vanish-connector" x1="118" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-2" class="vanish-connector" x1="122" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-3" class="vanish-connector" x1="170" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-4" class="vanish-connector" x1="174" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-5" class="vanish-connector" x1="260" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-6" class="vanish-connector" x1="264" y1="116" x2="0" y2="0"></line>
                        <line id="vanish-connector-7" class="vanish-connector" x1="350" y1="116" x2="0" y2="0"></line>
                        <rect id="mattress-element-0" class="visualizer-line" x="0" y="108" width="118" height="16" rx="2" ry="2"></rect>
                        <rect id="mattress-element-1" class="visualizer-line" x="122" y="108" width="48" height="16" rx="2" ry="2"></rect>
                        <rect id="mattress-element-2" class="visualizer-line" x="174" y="108" width="86" height="16" rx="2" ry="2"></rect>
                        <rect id="mattress-element-3" class="visualizer-line" x="264" y="108" width="86" height="16" rx="2" ry="2"></rect>
                        <foreignObject id="head-pos-text-container" class="position-text-container" x="-10" y="78">
                            <div id="head-pos-text" class="position-text-svg" style="text-align: left;">0s</div>
                        </foreignObject>
                        <foreignObject id="foot-pos-text-container" class="position-text-container" x="310" y="78">
                            <div id="foot-pos-text" class="position-text-svg" style="text-align: right;">0s</div>
                        </foreignObject>
                    </svg>
                </div>
            </div>

        <div id="bed-tab-content" class="btn-group tab-panel active">

            <div class="row" id="rocker-row">
                <div class="rocker-btn">
                    <button id="btn-head-up" class="rocker-up control-btn" ontouchstart="handlePressStart('HEAD_UP', this, 'touch')" ontouchend="handlePressEnd('touch')" onmousedown="handlePressStart('HEAD_UP', this, 'mouse')" onmouseup="handlePressEnd('mouse')">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <div class="rocker-label-inset">HEAD</div>
                    <button id="btn-head-down" class="rocker-down control-btn" ontouchstart="handlePressStart('HEAD_DOWN', this, 'touch')" ontouchend="handlePressEnd('touch')" onmousedown="handlePressStart('HEAD_DOWN', this, 'mouse')" onmouseup="handlePressEnd('mouse')">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                <div class="rocker-btn">
                    <button id="btn-all-up" class="rocker-up all-btn" ontouchstart="handlePressStart('ALL_UP', this, 'touch')" ontouchend="handlePressEnd('touch')" onmousedown="handlePressStart('ALL_UP', this, 'mouse')" onmouseup="handlePressEnd('mouse')">
                        <i class="fas fa-angles-up"></i>
                    </button>
                    <div class="rocker-label-inset">ALL</div>
                    <button id="btn-all-down" class="rocker-down all-btn" ontouchstart="handlePressStart('ALL_DOWN', this, 'touch')" ontouchend="handlePressEnd('touch')" onmousedown="handlePressStart('ALL_DOWN', this, 'mouse')" onmouseup="handlePressEnd('mouse')">
                        <i class="fas fa-angles-down"></i>
                    </button>
                </div>
                <div class="rocker-btn">
                    <button id="btn-foot-up" class="rocker-up control-btn" ontouchstart="handlePressStart('FOOT_UP', this, 'touch')" ontouchend="handlePressEnd('touch')" onmousedown="handlePressStart('FOOT_UP', this, 'mouse')" onmouseup="handlePressEnd('mouse')">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <div class="rocker-label-inset">FOOT</div>
                    <button id="btn-foot-down" class="rocker-down control-btn" ontouchstart="handlePressStart('FOOT_DOWN', this, 'touch')" ontouchend="handlePressEnd('touch')" onmousedown="handlePressStart('FOOT_DOWN', this, 'mouse')" onmouseup="handlePressEnd('mouse')">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
            </div>
            
            <div class="row row-3-btn" id="stop-row">
                <button id="btn-flat" class="preset-btn flat-btn" onclick="sendCmd('FLAT', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline points="0,14 24,14"></polyline>
                    </svg>
                    <span>Flat</span>
                </button>
                <button id="stop-btn-main" class="stop-btn" onclick="stopCmd(true)">
                    <i class="fas fa-stop-circle"></i> <span>STOP</span>
                </button>
                <button id="btn-max" class="preset-btn max-btn" onclick="sendCmd('MAX', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline points="0,4 10,14 14,14 20,9 24,9"></polyline>
                    </svg>
                    <span>Max</span>
                </button>
            </div>
                                
            <div class="row row-3-btn">
                <button id="btn-zg" class="preset-btn custom-preset-btn" onclick="sendCmd('ZERO_G', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline id="zg-icon-line" points="0,14 24,14"></polyline>
                    </svg>
                    <span id="zg-label-text">Zero G</span>
                </button>
                <button id="btn-snore" class="preset-btn custom-preset-btn" onclick="sendCmd('ANTI_SNORE', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline id="snore-icon-line" points="0,14 24,14"></polyline>
                    </svg>
                    <span id="snore-label-text">Anti-Snore</span>
                </button>
                <button id="btn-legs" class="preset-btn custom-preset-btn" onclick="sendCmd('LEGS_UP', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline id="legs-icon-line" points="0,14 24,14"></polyline>
                    </svg>
                    <span id="legs-label-text">Legs Up</span>
                </button>
            </div>
            
            <div class="row row-3-btn">
                <button id="btn-p1" class="preset-btn custom-preset-btn" onclick="sendCmd('P1', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline id="p1-icon-line" points="0,14 24,14"></polyline>
                    </svg>
                    <span id="p1-label-text">P1</span>
                </button>
                <button id="btn-p2" class="preset-btn custom-preset-btn" onclick="sendCmd('P2', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline id="p2-icon-line" points="0,14 24,14"></polyline>
                    </svg>
                    <span id="p2-label-text">P2</span>
                </button>
            </div>          

        </div>
    </div>
    <div id="set-modal" class="modal-backdrop">
        <div class="settings-sheet">
            <div class="settings-header">
                <button class="settings-back" onclick="closeSetModal()"><i class="fas fa-chevron-left"></i></button>
                <div class="settings-title">Settings</div>
                <div class="settings-spacer"></div>
            </div>
            <div class="settings-body">

                <div class="settings-card" data-section="presets">
                    <div class="settings-card-title">Presets</div>
                    <div class="settings-field">
                        <label for="preset-select">Preset</label>
                        <select id="preset-select" onchange="onModalDropdownChange()">
                            <option value="zg">Zero G</option>
                            <option value="snore">Anti-Snore</option>
                            <option value="legs">Legs Up</option>
                            <option value="p1">P1</option>
                            <option value="p2">P2</option>
                        </select>
                    </div>
                    <div class="settings-subhead">Label</div>
                    <div class="settings-field">
                        <input type="text" id="preset-label-input" placeholder="Type new label..." maxlength="10" oninput="onModalInputChange()">
                    </div>
                    <div class="settings-actions">
                        <button id="modal-save-label-btn" class="control-btn" onclick="savePresetLabel()">Rename</button>
                        <button id="modal-reset-label-btn" class="reset-btn ghost" onclick="resetPresetLabel()">Reset</button>
                    </div>
                    <div class="settings-subhead">Position</div>
                    <div class="settings-note" id="modal-pos-text">Head: 0s -> 0s, Foot: 0s -> 0s</div>
                    <div class="settings-actions">
                        <button id="modal-save-pos-btn" class="control-btn" onclick="savePresetPos()">Overwrite</button>
                        <button id="modal-reset-pos-btn" class="reset-btn ghost" onclick="resetPresetPos()">Reset</button>
                    </div>
                </div>

                <div class="settings-card" data-section="look">
                    <div class="settings-card-title">Look &amp; Feel</div>
                    <div class="settings-field">
                        <label for="style-select">Style</label>
                        <select id="style-select" onchange="onStyleChange()">
                            <option value="style-b">Olive Outline</option>
                            <option value="style-c">Circular Minimal</option>
                            <option value="style-a">Classic</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="brand-select">Brand</label>
                        <select id="brand-select" onchange="onBrandChange()">
                            <option value="homeyantric">HomeYantric</option>
                        </select>
                    </div>
                </div>

                <div class="settings-card" data-section="limits">
                    <div class="settings-card-title">Travel limits</div>
                    <div class="settings-field two-col">
                        <div>
                            <label for="limit-head-input">Head max (s)</label>
                            <input type="number" id="limit-head-input" min="5" max="60" step="1">
                        </div>
                        <div>
                            <label for="limit-foot-input">Foot max (s)</label>
                            <input type="number" id="limit-foot-input" min="5" max="60" step="1">
                        </div>
                    </div>
                    <div class="settings-actions single">
                        <button class="control-btn" onclick="saveLimits()">Save limits</button>
                    </div>
                </div>

                <div class="settings-card" data-section="debug">
                    <div class="settings-card-title">Debug logs</div>
                    <div class="settings-note">Toggle relay, peer lookup, UI press, and SSE remote logging.</div>
                    <div class="settings-actions">
                        <button class="control-btn ghost" onclick="setRelayLog(true)">Enable Relay Log</button>
                        <button class="control-btn ghost" onclick="setRelayLog(false)">Disable Relay Log</button>
                    </div>
                    <div class="settings-actions">
                        <button class="control-btn ghost" onclick="setPeerLog(true)">Enable Peer Log</button>
                        <button class="control-btn ghost" onclick="setPeerLog(false)">Disable Peer Log</button>
                    </div>
                    <div class="settings-actions">
                        <button class="control-btn ghost" onclick="setUiPressLog(true)">Enable UI Press Log</button>
                        <button class="control-btn ghost" onclick="setUiPressLog(false)">Disable UI Press Log</button>
                    </div>
                    <div class="settings-actions">
                        <button class="control-btn ghost" onclick="setSseLog(true)">Enable SSE Log</button>
                        <button class="control-btn ghost" onclick="setSseLog(false)">Disable SSE Log</button>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-meta">
                        <div class="settings-meta-row">
                            <span class="settings-meta-label">Log storage</span>
                            <span id="log-storage-value" class="settings-meta-value">-</span>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="control-btn ghost" onclick="refreshLogStorage()">Refresh storage</button>
                        <button class="reset-btn ghost" onclick="clearLogs()">Clear logs</button>
                    </div>
                </div>

                <div class="settings-card" data-section="labels">
                    <div class="settings-card-title">Rename Device/Room</div>
                    <div class="settings-note">Set the local device name and room for peer discovery.</div>
                    <div class="settings-field two-col">
                        <div>
                            <label for="label-device-input">Device name</label>
                            <input type="text" id="label-device-input" maxlength="32" placeholder="e.g. bed-north">
                        </div>
                        <div>
                            <label for="label-room-input">Room</label>
                            <input type="text" id="label-room-input" maxlength="32" placeholder="e.g. Master Bedroom">
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="control-btn" onclick="saveDeviceLabels()">Save labels</button>
                        <button class="reset-btn ghost" onclick="resetDeviceLabels()">Reset to defaults</button>
                    </div>
                    <div id="label-status" class="small-text"></div>
                </div>

                <div class="settings-card" data-section="wiring">
                    <div class="settings-card-title">Analog Wiring</div>
                    <div class="settings-note">Choose the analog/PWM wiring type for this device.</div>
                    <div class="settings-field">
                        <label for="light-wiring-select">Wiring type</label>
                        <select id="light-wiring-select"></select>
                    </div>
                    <div id="light-wiring-order-wrap" class="settings-field hidden">
                        <label for="light-wiring-order-select">Pixel order</label>
                        <select id="light-wiring-order-select"></select>
                    </div>
                    <div id="light-wiring-count-wrap" class="settings-field hidden">
                        <label for="light-wiring-count">Pixel count</label>
                        <input id="light-wiring-count" type="number" min="1" max="600" step="1" placeholder="90">
                    </div>
                    <div class="settings-meta">
                        <div class="settings-meta-row">
                            <span class="settings-meta-label">Terminals</span>
                            <span id="light-wiring-terminals" class="settings-meta-value">-</span>
                        </div>
                        <div class="settings-meta-row">
                            <span class="settings-meta-label">Channels</span>
                            <span id="light-wiring-channels" class="settings-meta-value">-</span>
                        </div>
                    </div>
                    <div class="settings-actions single">
                        <button class="control-btn" onclick="saveLightWiring()">Save wiring</button>
                    </div>
                    <div id="light-wiring-status" class="small-text"></div>
                </div>

                <div class="settings-card" data-section="ota">
                    <div class="settings-card-title">Firmware update (OTA)</div>
                    <div class="settings-field">
                        <input type="file" id="ota-file-input" accept=".bin" onchange="onOtaFileChange()">
                        <div id="ota-status" class="small-text">Choose a .bin firmware file.</div>
                        <div class="ota-progress">
                            <div id="ota-progress-bar"></div>
                        </div>
                    </div>
                    <div class="settings-actions single">
                        <button id="ota-upload-btn" class="control-btn" onclick="uploadFirmware()">Upload &amp; Reboot</button>
                    </div>
                </div>

                <div class="settings-card danger" data-section="network">
                    <div class="settings-card-title">Network</div>
                    <div class="settings-note">Reset WiFi settings and reboot into setup mode.</div>
                    <div class="settings-actions single">
                        <button class="reset-btn" onclick="resetNetwork()"><i class="fas fa-wifi"></i> Reset Network Settings</button>
                        <button class="stop-btn ghost" onclick="closeSetModal()">Close</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

        <div id="light-tab" class="tab-panel hidden">
            <div class="light-card light-card--header">
                <div class="light-header">
                    <div class="light-title">
                        <h2>Lights</h2>
                        <div id="light-subtitle" class="light-subtitle">Discovered devices</div>
                    </div>
                <div class="light-header-actions">
                        <button class="light-refresh" onclick="refreshPeers()"><i class="fas fa-sync-alt"></i> Refresh</button>
                        <span id="light-refresh-status" class="light-refresh-status"></span>
                    </div>
                </div>
            </div>
            <div id="light-wiring-gate" class="light-card light-wiring-gate hidden">
                <div class="light-header">
                    <div class="light-title">
                        <h2>Select Light Type</h2>
                        <div class="light-subtitle">Choose the light you are wiring to this controller.</div>
                    </div>
                </div>
                <div class="light-body">
                    <div class="settings-field">
                        <label for="light-wiring-gate-select">Light type</label>
                        <select id="light-wiring-gate-select"></select>
                    </div>
                    <div id="light-wiring-gate-order-wrap" class="settings-field hidden">
                        <label for="light-wiring-gate-order-select">Pixel order</label>
                        <select id="light-wiring-gate-order-select"></select>
                    </div>
                    <div id="light-wiring-gate-count-wrap" class="settings-field hidden">
                        <label for="light-wiring-gate-count">Pixel count</label>
                        <input id="light-wiring-gate-count" type="number" min="1" max="600" step="1" placeholder="90">
                    </div>
                    <div class="settings-meta">
                        <div class="settings-meta-row">
                            <span class="settings-meta-label">Terminals</span>
                            <span id="light-wiring-gate-terminals" class="settings-meta-value">-</span>
                        </div>
                        <div class="settings-meta-row">
                            <span class="settings-meta-label">Wire count</span>
                            <span id="light-wiring-gate-channels" class="settings-meta-value">-</span>
                        </div>
                    </div>
                    <div class="settings-actions single">
                        <button class="control-btn" onclick="saveLightWiringGate()">Save and continue</button>
                    </div>
                    <div id="light-wiring-gate-status" class="small-text"></div>
                </div>
            </div>
            <div id="light-filters" class="light-filters"></div>
            <div id="light-rooms" class="light-rooms"></div>
            <template id="light-card-template">
                <div class="light-card light-card--device">
                <div class="light-loading">
                    <div class="light-loading-card">
                        <div class="light-loading-spinner"></div>
                        <div class="light-loading-text">Syncing light state...</div>
                    </div>
                </div>
                <div class="light-header">
                    <div class="light-status light-status-line">Unknown</div>
                    <button class="light-detail-btn" type="button" aria-label="Show light controls">
                        <i class="fas fa-sliders"></i>
                        <span>Controls</span>
                    </button>
                </div>
                <div class="light-body">
                    <button class="light-toggle light-toggle-btn" type="button">
                        <span class="light-toggle-icon"><i class="fas fa-power-off"></i></span>
                        <span class="light-toggle-main">
                            <span class="light-toggle-title">Light</span>
                            <span class="light-toggle-meta">Unknown room</span>
                            <span class="light-toggle-status">
                                <span class="light-toggle-status-text">Not set</span>
                                <span class="light-toggle-status-swatch" aria-hidden="true"></span>
                                <span class="light-toggle-status-save" aria-live="polite"></span>
                            </span>
                        </span>
                        <span class="light-toggle-state">
                            <i class="fas fa-lightbulb"></i>
                            <span class="light-toggle-slash"></span>
                        </span>
                    </button>
                    <div class="light-detail-panel" role="dialog" aria-label="Light controls">
                        <div class="light-detail-body">
                            <div class="light-brightness">
                                <div class="light-brightness-bar">
                                    <div class="light-brightness-track">
                                        <div class="light-brightness-fill"></div>
                                        <button class="light-brightness-step light-brightness-step--down" type="button" aria-label="Decrease brightness">-</button>
                                        <input class="light-brightness-slider" type="range" min="0" max="100" value="0">
                                        <button class="light-brightness-step light-brightness-step--up" type="button" aria-label="Increase brightness">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="light-rgb-controls hidden">
                                <div class="light-rgb-header">
                                    <div class="light-rgb-label">RGB Channels</div>
                                    <div class="light-color-wheel" aria-label="RGB color wheel">
                                        <canvas class="light-color-canvas" width="160" height="160"></canvas>
                                        <div class="light-color-thumb"></div>
                                    </div>
                                    <button class="light-rgb-expand" type="button" aria-label="Expand color wheel">Expand</button>
                                    <div class="light-rgb-levels">R0 G0 B0</div>
                                </div>
                                <div class="light-rgb-presets">
                                    <div class="light-rgb-presets-header">
                                        <span class="light-rgb-presets-label">Presets</span>
                                        <span class="light-rgb-presets-hint">Tap to apply, hold to save</span>
                                        <button class="light-rgb-presets-edit" type="button" aria-label="Edit preset scenes">Edit</button>
                                    </div>
                                    <div class="light-rgb-presets-buttons">
                                        <button class="light-preset-btn" type="button" data-slot="1" aria-label="Preset 1"></button>
                                        <button class="light-preset-btn" type="button" data-slot="2" aria-label="Preset 2"></button>
                                        <button class="light-preset-btn" type="button" data-slot="3" aria-label="Preset 3"></button>
                                        <button class="light-preset-btn" type="button" data-slot="4" aria-label="Preset 4"></button>
                                        <button class="light-preset-btn" type="button" data-slot="5" aria-label="Preset 5"></button>
                                        <button class="light-preset-btn" type="button" data-slot="6" aria-label="Preset 6"></button>
                                    </div>
                                </div>
                                <div class="light-rgb-sliders">
                                    <div class="light-rgb-row" data-channel="r">
                                        <div class="light-rgb-track">
                                            <div class="light-rgb-fill"></div>
                                            <span class="light-rgb-chip light-rgb-chip--r">R</span>
                                            <input class="light-rgb-slider" data-channel="r" type="range" min="0" max="100" value="0">
                                        </div>
                                    </div>
                                    <div class="light-rgb-row" data-channel="g">
                                        <div class="light-rgb-track">
                                            <div class="light-rgb-fill"></div>
                                            <span class="light-rgb-chip light-rgb-chip--g">G</span>
                                            <input class="light-rgb-slider" data-channel="g" type="range" min="0" max="100" value="0">
                                        </div>
                                    </div>
                                    <div class="light-rgb-row" data-channel="b">
                                        <div class="light-rgb-track">
                                            <div class="light-rgb-fill"></div>
                                            <span class="light-rgb-chip light-rgb-chip--b">B</span>
                                            <input class="light-rgb-slider" data-channel="b" type="range" min="0" max="100" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="light-digital-controls hidden">
                                <div class="light-digital-group light-digital-group--solid">
                                    <div class="light-digital-title">Solid</div>
                                    <div class="light-digital-row light-digital-solids">
                                        <button class="light-digital-fill light-swatch light-swatch--r" type="button" data-color="r" aria-label="Solid Red"><span>Red</span></button>
                                        <button class="light-digital-fill light-swatch light-swatch--g" type="button" data-color="g" aria-label="Solid Green"><span>Green</span></button>
                                        <button class="light-digital-fill light-swatch light-swatch--b" type="button" data-color="b" aria-label="Solid Blue"><span>Blue</span></button>
                                        <button class="light-digital-fill light-swatch light-swatch--w" type="button" data-color="w" aria-label="Solid White"><span>White</span></button>
                                        <button class="light-digital-fill light-swatch light-swatch--ww" type="button" data-color="ww" aria-label="Solid Warm White"><span>Warm</span></button>
                                    </div>
                                </div>
                                <div class="light-digital-group light-digital-group--palette">
                                    <div class="light-digital-title">Palette</div>
                                    <div class="light-digital-row light-digital-palettes"></div>
                                </div>
                                <div class="light-digital-group light-digital-group--effects">
                                    <div class="light-digital-title">Effects</div>
                                    <div class="light-digital-row light-digital-effects">
                                        <button class="light-effect-btn light-digital-chase" type="button">Chase</button>
                                        <button class="light-effect-btn light-digital-wipe" type="button">Wipe</button>
                                        <button class="light-effect-btn light-digital-pulse" type="button">Pulse</button>
                                        <button class="light-effect-btn light-digital-rainbow" type="button">Rainbow</button>
                                        <button class="light-effect-btn light-effect-stop" type="button">Stop</button>
                                    </div>
                                    <div class="light-effect-controls">
                                        <div class="light-effect-toggle">
                                            <span class="light-effect-label">Run</span>
                                            <div class="light-effect-segment">
                                                <button class="light-effect-mode is-active" type="button" data-mode="once">Once</button>
                                                <button class="light-effect-mode" type="button" data-mode="loop">Loop</button>
                                            </div>
                                        </div>
                                        <div class="light-effect-toggle">
                                            <span class="light-effect-label">Direction</span>
                                            <div class="light-effect-segment">
                                                <button class="light-effect-direction is-active" type="button" data-direction="forward">Forward</button>
                                                <button class="light-effect-direction" type="button" data-direction="pingpong">Ping-Pong</button>
                                            </div>
                                        </div>
                                        <div class="light-effect-speed">
                                            <span class="light-effect-label">Speed</span>
                                            <input class="light-effect-speed-slider" type="range" min="10" max="200" value="30">
                                            <span class="light-effect-speed-value">30ms</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="light-info-toggle">
                                <button class="light-info-btn" type="button" aria-label="Show device info">
                                    <i class="fas fa-circle-info"></i>
                                    <span>Info</span>
                                </button>
                            </div>
                            <div class="light-meta light-meta--collapsible">
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Status</span>
                                    <span class="light-meta-value light-status-detail">Waiting</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Last seen</span>
                                    <span class="light-meta-value light-last-seen">Never</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Device</span>
                                    <span class="light-meta-value light-device-name">Unknown</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Host</span>
                                    <span class="light-meta-value light-device-host">Unknown</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Wiring</span>
                                    <span class="light-meta-value light-wiring-summary">Unknown</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Pixels</span>
                                    <span class="light-meta-value light-wiring-count">-</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Terminals</span>
                                    <span class="light-meta-value light-wiring-terminals">-</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">Brightness</span>
                                    <span class="light-meta-value light-brightness-value">0%</span>
                                </div>
                                <div class="light-meta-row">
                                    <span class="light-meta-label">FW</span>
                                    <span class="light-meta-value light-device-fw">Unknown</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    </div>


    <div id="alert-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="alert-title">Alert</h2>
            <p id="alert-message"></p>
            <button class="control-btn" onclick="closeCustomAlert()">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="confirm-title">Confirm</h2>
            <p id="confirm-message"></p>
            <div class="modal-btn-group-row">
                <button class="stop-btn" onclick="closeCustomConfirm(false)">Cancel</button>
                <button class="control-btn" onclick="closeCustomConfirm(true)">OK</button>
            </div>
        </div>
    </div>

    <div id="light-wheel-modal" class="modal-backdrop">
        <div class="modal-content light-wheel-modal">
            <div class="light-wheel-modal-header">
                <div class="light-wheel-modal-title">Color Wheel</div>
                <div class="light-wheel-modal-actions">
                    <button class="light-wheel-modal-cancel" type="button" aria-label="Cancel color edit">Cancel</button>
                    <button class="light-wheel-modal-save" type="button" aria-label="Save preset color">Save</button>
                </div>
            </div>
            <div class="light-wheel-modal-body">
                <div class="light-color-wheel light-color-wheel--modal" aria-label="RGB color wheel">
                    <canvas class="light-color-canvas" width="320" height="320"></canvas>
                    <div class="light-color-thumb"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="light-scene-modal" class="modal-backdrop">
        <div class="modal-content light-scene-modal">
            <div class="light-scene-modal-header">
                <div class="light-scene-modal-title">Scene Preset</div>
                <button class="light-scene-modal-close" type="button" aria-label="Close scene editor">Close</button>
            </div>
            <div class="light-scene-modal-body">
                <div class="light-scene-row">
                    <span class="light-scene-label">Slot</span>
                    <div class="light-scene-slots">
                        <button type="button" class="light-scene-slot" data-slot="1">1</button>
                        <button type="button" class="light-scene-slot" data-slot="2">2</button>
                        <button type="button" class="light-scene-slot" data-slot="3">3</button>
                        <button type="button" class="light-scene-slot" data-slot="4">4</button>
                        <button type="button" class="light-scene-slot" data-slot="5">5</button>
                        <button type="button" class="light-scene-slot" data-slot="6">6</button>
                    </div>
                </div>
                <div class="light-scene-preview">
                    <div class="light-scene-preview-swatch"></div>
                    <div class="light-scene-preview-text">Preview</div>
                </div>
                <div class="light-scene-row">
                    <span class="light-scene-label">Mode</span>
                    <div class="light-scene-segment">
                        <button class="light-scene-mode" type="button" data-mode="solid">Solid</button>
                        <button class="light-scene-mode" type="button" data-mode="palette">Palette</button>
                        <button class="light-scene-mode" type="button" data-mode="effect">Effect</button>
                    </div>
                </div>
                <div class="light-scene-panel light-scene-panel--solid">
                    <div class="light-scene-rgb">
                        <div class="light-scene-rgb-row" data-channel="r">
                            <span class="light-scene-rgb-chip light-scene-rgb-chip--r">R</span>
                            <input class="light-scene-rgb-slider" data-channel="r" type="range" min="0" max="100" value="0">
                        </div>
                        <div class="light-scene-rgb-row" data-channel="g">
                            <span class="light-scene-rgb-chip light-scene-rgb-chip--g">G</span>
                            <input class="light-scene-rgb-slider" data-channel="g" type="range" min="0" max="100" value="0">
                        </div>
                        <div class="light-scene-rgb-row" data-channel="b">
                            <span class="light-scene-rgb-chip light-scene-rgb-chip--b">B</span>
                            <input class="light-scene-rgb-slider" data-channel="b" type="range" min="0" max="100" value="0">
                        </div>
                    </div>
                </div>
                <div class="light-scene-panel light-scene-panel--palette">
                    <div class="light-scene-palette-list"></div>
                </div>
                <div class="light-scene-panel light-scene-panel--effect">
                    <div class="light-scene-effect-list">
                        <button class="light-scene-effect" type="button" data-effect="chase">Chase</button>
                        <button class="light-scene-effect" type="button" data-effect="wipe">Wipe</button>
                        <button class="light-scene-effect" type="button" data-effect="pulse">Pulse</button>
                        <button class="light-scene-effect" type="button" data-effect="rainbow">Rainbow</button>
                    </div>
                    <div class="light-scene-row">
                        <span class="light-scene-label">Run</span>
                        <div class="light-scene-segment">
                            <button class="light-scene-effect-mode" type="button" data-mode="once">Once</button>
                            <button class="light-scene-effect-mode" type="button" data-mode="loop">Loop</button>
                        </div>
                    </div>
                    <div class="light-scene-row">
                        <span class="light-scene-label">Direction</span>
                        <div class="light-scene-segment">
                            <button class="light-scene-effect-direction" type="button" data-direction="forward">Forward</button>
                            <button class="light-scene-effect-direction" type="button" data-direction="pingpong">Ping-Pong</button>
                        </div>
                    </div>
                    <div class="light-scene-row">
                        <span class="light-scene-label">Speed</span>
                        <input class="light-scene-delay-slider" type="range" min="10" max="200" value="30">
                        <span class="light-scene-delay-value">30ms</span>
                    </div>
                    <div class="light-scene-row">
                        <span class="light-scene-label">Steps</span>
                        <input class="light-scene-steps-slider" type="range" min="1" max="200" value="90">
                        <span class="light-scene-steps-value">90</span>
                    </div>
                </div>
                <div class="light-scene-row">
                    <span class="light-scene-label">Brightness</span>
                    <input class="light-scene-brightness-slider" type="range" min="0" max="100" value="100">
                    <span class="light-scene-brightness-value">100%</span>
                </div>
            </div>
            <div class="light-scene-modal-actions">
                <button class="light-scene-apply" type="button">Apply</button>
                <button class="light-scene-save" type="button">Save</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" aria-live="polite"></div>

    <script src="bed-visualizer.js?v=2"></script>
    <script src="app.js?v=2"></script>
</body>
</html>
