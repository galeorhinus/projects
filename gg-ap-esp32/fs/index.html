<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Wi-Fi Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
    .container { max-width: 500px; width: 100%; margin: 20px; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    h2 { text-align: center; color: #1c1e21; margin-top: 0; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b4f56; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 12px; border: 1px solid #dddfe2;
      border-radius: 6px; box-sizing: border-box; font-size: 16px;
    }
    button {
      width: 100%; padding: 12px; background: #007bff; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-size: 17px; font-weight: 600;
    }
    button:disabled { background: #aaa; cursor: not-allowed; }
    #message { 
      margin-top: 20px; text-align: center; font-size: 15px; 
      padding: 15px; border-radius: 6px; line-height: 1.5;
      display: none; /* Hidden by default */
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #007bff;
      border-radius: 50%; width: 20px; height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block; margin-right: 10px; vertical-align: middle;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="container">
    <h2>Set Up Wi-Fi</h2>
    
    <div id="form-container">
      <p style="text-align: center; color: #4b4f56;">Please enter your home Wi-Fi credentials below.</p>
      <div class="form-group">
        <label for="ssid">Wi-Fi Network (SSID)</label>
        <input type="text" id="ssid">
      </div>
      <div class="form-group">
        <label for="pass">Password</label>
        <input type="password" id="pass">
      </div>
      <button id="save-button" onclick="saveWifi()">Save & Connect</button>
    </div>

    <!-- Message area for status updates -->
    <div id="message"></div>
  </div>

  <script>
    let statusInterval = null; // Holds the poller

    // Helper function to call Mongoose OS RPC
    function callRPC(method, params) {
      return fetch('/rpc/' + method, {
        method: 'POST',
        body: JSON.stringify(params || {}),
        headers: {'Content-Type': 'application/json'}
      }).then(function(res) {
        if (!res.ok) { 
          // This will be caught by the .catch() block
          throw new Error('RPC call failed: ' + res.status); 
        }
        return res.json();
      });
    }

    // --- UPDATED POLLING FUNCTION ---
    function checkStatus() {
      let msgEl = document.getElementById('message');
      
      // We call the *built-in* "Wifi.GetStatus" function,
      // which is provided by the 'rpc-service-wifi' library.
      callRPC('Wifi.GetStatus', {})
        .then(function(status) {
          // 'status' will be { ssid: "galeasus24", status: "got_ip", ip: "192.168.0.14" }

          if (status.status === "got_ip" && status.ip) {
            // --- SUCCESS (FINAL STATE) ---
            // We have an IP! Stop polling and show the result.
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = null;
            
            document.getElementById('form-container').style.display = 'none'; // Hide form
            msgEl.innerHTML = '<strong>Success! Device is connected.</strong>' +
              '<hr style="border:0; border-top:1px solid #eee; margin:15px 0;">' +
              'Your device is now on your home network at:' +
              '<br><br>' +
              '<a href="http://' + status.ip + '" target="_blank" style="font-weight: 600; font-size: 1.2rem;">http://' + status.ip + '</a>' +
              '<br><br>' +
              '<small>You can now close this page. This setup network will remain active.</small>';
            
            msgEl.style.color = '#155724'; // Dark Green
            msgEl.style.background = '#d4edda'; // Light Green
            msgEl.style.textAlign = 'left';
            msgEl.style.display = 'block';

          } else if (status.ssid) {
            // --- CONNECTING ---
            // Configured, but no IP yet. Show "Connecting..."
            msgEl.innerHTML = '<div class="spinner"></div>' +
              'Connecting to <b>' + status.ssid + '</b>...<br>' +
              'Please wait. This page will update automatically.';
            msgEl.style.color = '#004085'; // Dark Blue
            msgEl.style.background = '#cce5ff'; // Light Blue
            msgEl.style.display = 'block';
            
          } else {
            // --- NOT CONFIGURED ---
            // This is the default state before saving (status.ssid is null)
            msgEl.style.display = 'none';
            document.getElementById('form-container').style.display = 'block';
          }
        })
        .catch(function(err) {
          // --- THIS IS THE FIX ---
          // The "No handler" error will be caught here.
          // We show an "Initializing" message instead of "Rebooting".
          console.log("checkStatus failed (RPC not ready or device rebooting), will retry.");
          
          // Only show this message if we are *not* already in the success state.
          if (statusInterval) { // statusInterval is only null after success
            msgEl.innerHTML = '<div class="spinner"></div>Initializing Wi-Fi service... Please wait.';
            msgEl.style.color = '#856404'; // Dark Yellow
            msgEl.style.background = '#fff3cd'; // Light Yellow
            msgEl.style.display = 'block';
          }
        });
    }

    // Called by the "Save & Connect" button
    function saveWifi() {
      let ssid = document.getElementById('ssid').value;
      let msgEl = document.getElementById('message');

      if (!ssid) {
        msgEl.innerHTML = 'Please enter an SSID.';
        msgEl.style.color = '#721c24'; // Dark Red
        msgEl.style.background = '#f8d7da'; // Light Red
        msgEl.style.display = 'block';
        return;
      }

      // Disable button
      document.getElementById('save-button').disabled = true;

      // Show "Saving..." message
      msgEl.innerHTML = '<div class="spinner"></div>' +
        'Saving credentials and rebooting... Please wait.';
      msgEl.style.color = '#004085'; // Dark Blue
      msgEl.style.background = '#cce5ff'; // Light Blue
      msgEl.style.display = 'block';

      // 1. Call the Save RPC
      callRPC('My.SaveWifi', { ssid: ssid, pass: document.getElementById('pass').value })
        .then(function() {
          // This promise resolving just means the RPC was *sent*.
          // The device is now rebooting.
          
          // 2. Start polling for status *after* device has time to reboot.
          // Clear any old poller first.
          if (statusInterval) clearInterval(statusInterval);
          
          // Wait 5 seconds for reboot to start, then start polling every 3s
          setTimeout(function() {
            checkStatus(); // Check immediately
            statusInterval = setInterval(checkStatus, 3000); // Then poll
          }, 5000); // 5-second delay
        })
        .catch(function(err) {
          // This shouldn't happen, but if it does, show an error
          msgEl.innerHTML = 'Error saving settings. Please try again.';
          msgEl.style.color = '#721c24';
          msgEl.style.background = '#f8d7da';
          document.gertElementById('save-button').disabled = false;
        });
    }

    // --- ON PAGE LOAD ---
    // When the page loads, check the status immediately.
    window.onload = function() {
      // Start polling right away in case we are in an already-configured state
      checkStatus();
      statusInterval = setInterval(checkStatus, 3000);
    };

  </script>
</body>
</html>