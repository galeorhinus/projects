<!DOCTYPE html>
<html>
<head>
    <title>Bed Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 400px;
        }
        h1 {
            text-align: center;
            color: #e5e7eb; /* gray-200 */
            margin-bottom: 20px;
        }
        
        /* --- Visualizer moved above buttons --- */
        .status {
            text-align: center;
            margin-bottom: 25px; /* Added margin */
            font-size: 14px;
            color: #a1a1aa; /* zinc-400 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px; 
            position: relative;
            padding-bottom: 10px; 
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: white;
            white-space: nowrap; 
            font-size: 15px; 
        }
        button i {
            font-size: 1.1em;
            margin-right: 4px; 
        }
        /* Adjust padding for 3-button rows */
        .row-3-btn button {
             padding: 20px 5px; /* Less horizontal padding */
             gap: 5px; /* Less gap */
        }

        button:active {
            transform: scale(0.97);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }

        /* --- NEW: Rocker Button Styles --- */
        .rocker-btn {
            flex: 1; /* Take up equal space */
            display: flex;
            flex-direction: column;
            border-radius: 8px; /* Rounded corners for the container */
            overflow: hidden; /* Clip the button halves */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .rocker-up, .rocker-down {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px 10px; /* Slightly less vertical padding */
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
            color: white;
            /* Remove individual button properties */
            border-radius: 0; 
            box-shadow: none;
            flex: 1; /* Each half takes equal space */
        }
        .rocker-up:active, .rocker-down:active {
            transform: scale(0.97); /* Keep the press effect */
        }
        /* Add a subtle line between them */
        .rocker-up {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* End Rocker Styles */


        .control-btn { background-color: #3b82f6; } /* blue-500 */
        .control-btn:hover { background-color: #2563eb; } /* blue-600 */
        
        .stop-btn { background-color: #ef4444; } /* red-500 */
        .stop-btn:hover { background-color: #dc2626; } /* red-600 */
        
        .preset-btn { background-color: #f59e0b; } /* amber-500 */
        .preset-btn:hover { background-color: #d97706; } /* amber-600 */
        
        .preset-btn.btn-running {
            background-color: #e11d48; /* rose-600 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .all-btn { background-color: #10b981; } /* emerald-500 */
        .all-btn:hover { background-color: #059669; } /* emerald-600 */
        
        .light-btn { background-color: #8b5cf6; } /* violet-500 */
        .light-btn:hover { background-color: #7c3aed; } /* violet-600 */
        
        .status-line {
            line-height: 1.5;
            font-size: 12px; /* CHANGED: Smaller font */
            color: #cbd5e1; /* CHANGED: Lighter color (slate-300) */
        }

        /* NEW: Container for the status lines */
        .status-line-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }


        /* --- Visualizer Styles --- */
        .status-visualizers { 
            display: flex;
            justify-content: center;
            gap: 0; /* No gap between visualizer SVG containers now */
            width: 100%;
            margin-bottom: 10px;
            position: relative; 
            z-index: 2;
            overflow: visible; /* Allow stroke-width to extend */
        }
        
        /* Container for the single SVG */
        .svg-container {
            width: 350px; /* Total width: 120 + 50 + 90 + 90 */
            height: 176px; /* CHANGED: Taller to fit legs */
            position: relative;
            margin: 0 auto;
        }

        .svg-visualizer {
            height: 176px; /* CHANGED: Taller */
            overflow: visible; 
            width: 100%;
        }

        .visualizer-line {
            stroke: #3b82f6; /* Blue color for lines - mattress */
            stroke-width: 36; /* Thicker mattress */ 
            fill: none; 
            stroke-linecap: round; 
            stroke-linejoin: round; 
            transition: d 0.2s ease-out, points 0.2s ease-out; 
        }
        
        #bed-base-line {
            stroke: #9ca3af; /* Gray for the frame/static parts */
            stroke-width: 12; /* Thinner frame */ 
            stroke-linecap: round;
        }

        .bed-leg-line {
            stroke: #9ca3af; /* Gray, to match the frame */
            stroke-width: 12; /* Thinner frame */
            stroke-linecap: round;
        }

        /* --- Label styles for above rockers --- */
        .rocker-label-row {
            margin-bottom: -5px; /* Pulls rockers up slightly */
            gap: 15px; /* Match button row gap */
        }
        .rocker-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            color: #e5e7eb; /* gray-200 */
            text-transform: uppercase;
        }
        .position-text {
            font-size: 1.1em;
            font-weight: 700;
            color: #f9fafb; /* gray-50 */
            text-align: center;
            height: 1.2em; /* Reserve height */
        }
        
        /* --- Custom Preset Icon SVG Style --- */
        .preset-icon-svg {
            width: 32px; /* Larger icon */
            height: 21px; /* Larger icon */
            margin-right: 8px; /* Space between icon and text */
            stroke: #ffffff; /* White icon color */
            stroke-width: 3.5; /* Bolder icon */
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-bed"></i> Bed Control</h1>

        <!-- Visualizer Section (Moved) -->
        <div class="status">
            
            <!-- Single SVG Container -->
            <div class="svg-container">
                <svg class="svg-visualizer" viewBox="0 0 350 176">
                    <!-- The main bed frame base -->
                    <line id="bed-base-line" x1="0" y1="140" x2="350" y2="140"></line>
                    
                    <!-- Bed Legs -->
                    <line class="bed-leg-line" x1="30" y1="140" x2="30" y2="176"></line> <!-- Left Leg -->
                    <line class="bed-leg-line" x1="175" y1="140" x2="175" y2="176"></line> <!-- Middle Leg -->
                    <line class="bed-leg-line" x1="320" y1="140" x2="320" y2="176"></line> <!-- Right Leg -->
                    
                    <!-- Single Polyline for the entire "mattress" -->
                    <polyline id="mattress-line" class="visualizer-line" points="0,116 120,116 170,116 260,116 350,116"></polyline>
                </svg>
            </div>
            <!-- End Single SVG Container -->

        </div>

        <!-- Button Section -->
        <div class="btn-group">

            <!-- Row for rocker labels and positions -->
            <div class="row rocker-label-row">
                <div class="rocker-label">
                    <div id="head-pos-text" class="position-text">0s</div>
                    <div>HEAD</div>
                </div>
                <div class="rocker-label">
                    <div class="position-text">&nbsp;</div> <!-- Empty spacer -->
                    <div>ALL</div>
                </div>
                <div class="rocker-label">
                    <div id="foot-pos-text" class="position-text">0s</div>
                    <div>FOOT</div>
                </div>
            </div>

            <!-- Rocker Button Row -->
            <div class="row">
                <!-- Head Rocker -->
                <div class="rocker-btn">
                    <button class="rocker-up control-btn" ontouchstart="sendCmd('HEAD_UP')" ontouchend="stopCmd(true)" onmousedown="sendCmd('HEAD_UP')" onmouseup="stopCmd(true)">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="rocker-down control-btn" ontouchstart="sendCmd('HEAD_DOWN')" ontouchend="stopCmd(true)" onmousedown="sendCmd('HEAD_DOWN')" onmouseup="stopCmd(true)">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                <!-- All Rocker -->
                <div class="rocker-btn">
                    <button class="rocker-up all-btn" ontouchstart="sendCmd('ALL_UP')" ontouchend="stopCmd(true)" onmousedown="sendCmd('ALL_UP')" onmouseup="stopCmd(true)">
                        <i class="fas fa-angles-up"></i>
                    </button>
                    <button class="rocker-down all-btn" ontouchstart="sendCmd('ALL_DOWN')" ontouchend="stopCmd(true)" onmousedown="sendCmd('ALL_DOWN')" onmouseup="stopCmd(true)">
                        <i class="fas fa-angles-down"></i>
                    </button>
                </div>
                <!-- Foot Rocker -->
                <div class="rocker-btn">
                    <button class="rocker-up control-btn" ontouchstart="sendCmd('FOOT_UP')" ontouchend="stopCmd(true)" onmousedown="sendCmd('FOOT_UP')" onmouseup="stopCmd(true)">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="rocker-down control-btn" ontouchstart="sendCmd('FOOT_DOWN')" ontouchend="stopCmd(true)" onmousedown="sendCmd('FOOT_DOWN')" onmouseup="stopCmd(true)">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
            </div>
            
            <!-- Stop --><div class="row">
                <button class="stop-btn" style="flex-grow: 2; font-size: 16px;" onclick="stopCmd(true)">
                    <i class="fas fa-stop-circle"></i> STOP ALL MOTORS
                </button>
            </div>
            
            <!-- Presets --><div class="row">
                <button id="btn-flat" class="preset-btn" style="font-size: 16px;" onclick="sendCmd('FLAT', this)">
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline points="0,14 24,14"></polyline>
                    </svg>
                    Flat
                </button>
                <button id="btn-zerog" class="preset-btn" style="font-size: 16px;" onclick="sendCmd('ZERO_G', this)">
                    <!-- Head: 30%, Foot: 93% (scaled) -->
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline points="0,11 10,14 14,14 20,9.3 24,9.3"></polyline>
                    </svg>
                    Zero G
                </button>
            </div>
            
            <!-- Presets --><div class="row">
                <button id="btn-snore" class="preset-btn" style="font-size: 16px;" onclick="sendCmd('ANTI_SNORE', this)">
                    <!-- Head: 30%, Foot: 0% -->
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline points="0,11 10,14 14,14 24,14"></polyline>
                    </svg>
                    Anti-Snore
                </button>
                <button id="btn-legs" class="preset-btn" style="font-size: 16px;" onclick="sendCmd('LEGS_UP', this)">
                    <!-- Head: 0%, Foot: 100% (scaled) -->
                    <svg class="preset-icon-svg" viewBox="0 0 24 18">
                        <polyline points="0,14 10,14 14,14 20,9 24,9"></polyline>
                    </svg>
                    Legs Up
                </button>
            </div>

            <!-- Light --><div class="row">
                <button class="light-btn" style="flex-grow: 2; font-size: 16px;" onclick="sendCmd('LIGHT_TOGGLE')">
                    <i class="fas fa-lightbulb"></i> Toggle Light
                </button>
            </div>

        </div> <!-- end btn-group -->
        
        <!-- CHANGED: Wrapped status lines in a container -->
        <div class="status-line-container">
            <div id="status-line-1" class="status-line">Connecting...</div>
            <div id="status-line-2" class="status-line"></div>
        </div>

    </div> <!-- end container --><script>
        // --- Client-side JavaScript ---

        var pressStartTime = 0;
        var activeCommand = "";
        var presetTimerId = null; // Timer for preset final status check
        
        // --- Max position constants (from init.js) ---
        const HEAD_MAX_SEC = 28;
        const FOOT_MAX_SEC = 43;
        
        // --- SVG Coordinate Constants ---
        const SVG_VIEWBOX_TRAVEL_HEIGHT = 108; // The max vertical travel of the mattress
        const FRAME_Y_POSITION = 140; // Y coordinate for the gray frame
        const MATTRESS_Y_BASE = 116; // Y coordinate for the flat (0%) mattress (140 - 24)
        
        // --- Head Section ---
        const HEAD_X_START = 0;
        const HEAD_X_END = 120;
        
        // --- Gap ---
        const GAP_X_START = 120;
        const GAP_X_END = 170;
        
        // --- Foot Section ---
        const FOOT_TRIANGLE_X_START = 170;
        const FOOT_TRIANGLE_X_END = 260; // 170 + 90
        const FOOT_BAR_X_START = 260;
        const FOOT_BAR_X_END = 350; // 260 + 90


        // --- Format boot timestamp ---
        // Converts a UNIX timestamp (in seconds) to "Nov 5, 8:30 PM"
        function formatBootTime(timestamp) {
            try {
                const date = new Date(timestamp * 1000);
                const options = {
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true
                };
                return date.toLocaleString(undefined, options);
            } catch (e) {
                console.error("Error formatting date:", e);
                return "Unknown";
            }
        }

        // --- NEW: Format duration in seconds to HH:MM:SS ---
        function formatDuration(totalSeconds) {
            try {
                let hours = Math.floor(totalSeconds / 3600);
                totalSeconds %= 3600;
                let minutes = Math.floor(totalSeconds / 60);
                let seconds = Math.floor(totalSeconds % 60);

                // Pad with leading zeros
                let hh = String(hours).padStart(2, '0');
                let mm = String(minutes).padStart(2, '0');
                let ss = String(seconds).padStart(2, '0');
                
                return hh + ":" + mm + ":" + ss;
            } catch (e) {
                console.error("Error formatting duration:", e);
                return "00:00:00";
            }
        }

        // --- Update status display ---
        function updateStatusDisplay(bootTime, uptime, headPos, footPos) { // <-- CHANGED: Added uptime
            var statusEl1 = document.getElementById("status-line-1");
            var statusEl2 = document.getElementById("status-line-2"); // <-- NEW
            var headPosTextEl = document.getElementById("head-pos-text");
            var footPosTextEl = document.getElementById("foot-pos-text");
            var mattressLineEl = document.getElementById("mattress-line"); 

            if (statusEl1 && statusEl2 && headPosTextEl && footPosTextEl && mattressLineEl) {
                // Format the boot time
                let formattedTime = formatBootTime(bootTime);
                // NEW: Format duration
                let formattedDuration = formatDuration(uptime); 
                
                statusEl1.textContent = "Up since: " + formattedTime;
                // NEW: Set duration text
                statusEl2.textContent = "Duration: " + formattedDuration;
                
                let headPosNum = 0;
                let footPosNum = 0;
                let headPercent = 0;
                let footPercent = 0;
                
                try {
                    headPosNum = parseFloat(headPos) || 0;
                    footPosNum = parseFloat(footPos) || 0;

                    headPercent = (headPosNum / HEAD_MAX_SEC) * 100;
                    footPercent = (footPosNum / FOOT_MAX_SEC) * 100;

                    headPercent = Math.max(0, Math.min(100, headPercent));
                    footPercent = Math.max(0, Math.min(100, footPercent));

                } catch (e) {
                    console.error("Error calculating percentages:", e);
                }

                // Update text position to show seconds
                headPosTextEl.textContent = headPosNum.toFixed(0) + "s";
                footPosTextEl.textContent = footPosNum.toFixed(0) + "s";


                // --- Calculate SVG Points ---
                
                let headY = MATTRESS_Y_BASE - (SVG_VIEWBOX_TRAVEL_HEIGHT * (headPercent / 100));
                let footY = MATTRESS_Y_BASE - (SVG_VIEWBOX_TRAVEL_HEIGHT * (footPercent / 100) * 0.5);
                
                // Set all points for the single mattress polyline
                let points = 
                    HEAD_X_START + ',' + headY + ' ' +           // 1. Head top-left
                    HEAD_X_END + ',' + MATTRESS_Y_BASE + ' ' +   // 2. Head bottom-right
                    GAP_X_START + ',' + MATTRESS_Y_BASE + ' ' +  // 3. Gap start (same point)
                    GAP_X_END + ',' + MATTRESS_Y_BASE + ' ' +    // 4. Gap end
                    FOOT_TRIANGLE_X_START + ',' + MATTRESS_Y_BASE + ' ' + // 5. Foot tri start (same point)
                    FOOT_TRIANGLE_X_END + ',' + footY + ' ' +    // 6. Foot tri top-right
                    FOOT_BAR_X_START + ',' + footY + ' ' +       // 7. Foot bar start (same point)
                    FOOT_BAR_X_END + ',' + footY;                // 8. Foot bar end
                
                mattressLineEl.setAttribute('points', points);
            }
        }

        // --- Helper to clear all running preset buttons ---
        function clearRunningPresets() {
            var allPresets = document.querySelectorAll('.preset-btn.btn-running');
            for (var i = 0; i < allPresets.length; i++) {
                allPresets[i].classList.remove('btn-running');
            }
        }

        // --- Send RPC Command ---
        function sendCmd(cmd, btnElement) {
            console.log("Sent: " + cmd);

            // This is a momentary (hold-down) button
            if (cmd !== "STOP" && cmd !== "LIGHT_TOGGLE" && !cmd.startsWith('FLAT') && !cmd.startsWith('ZERO_G') && !cmd.startsWith('ANTI_SNORE') && !cmd.startsWith('LEGS_UP')) {
                pressStartTime = Date.now();
                activeCommand = cmd;
            }

            // This is a preset (one-click) button
            if (btnElement) {
                clearRunningPresets(); // Clear any other running presets
                btnElement.classList.add('btn-running'); // Set this one as running
            }
            
            // --- Use RPC POST request ---
            fetch('/rpc/Bed.Command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cmd: cmd })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(function(status) {
                // Mongoose OS RPC wraps the actual return value in a "result" object
                let result = status.result || status;
                console.log("Received immediate status:", JSON.stringify(result));
                updateStatusDisplay(result.bootTime, result.uptime, result.headPos, result.footPos);

                // If this was a preset, set a timer to fetch final status
                if (cmd === "ZERO_G" || cmd === "FLAT" || cmd === "ANTI_SNORE" || cmd === "LEGS_UP") {
                    var maxWait = parseInt(result.maxWait) || 0;
                    if (maxWait > 0) {
                        // Use server-provided time + 1.5s buffer
                        var waitMs = maxWait + 1500;
                        console.log(cmd + ": Setting timer to fetch final status in " + (waitMs / 1000) + "s");
                        
                        // Clear any old timer before setting a new one
                        if (presetTimerId) clearTimeout(presetTimerId);
                        
                        presetTimerId = setTimeout(function() {
                            stopCmd(false); // Call stopCmd to fetch status (not a manual press)
                        }, waitMs);
                    } else {
                        // No movement, just clear the button
                        clearRunningPresets();
                    }
                }
            })
            .catch(function(error) {
                console.error("Fetch error for " + cmd + ":", error);
                clearRunningPresets(); // Stop pulsing on error
            });
        }

        // --- Stop Command / Status Fetch ---
        function stopCmd(isManualPress) {
            // Clear any pending preset timer
            if (presetTimerId) {
                let timerToClear = presetTimerId;
                clearTimeout(presetTimerId);
                presetTimerId = null;
                console.log("Clearing preset timer (" + timerToClear + ") due to STOP command.");
            }
            // Clear all pulsing buttons
            clearRunningPresets();

            if (pressStartTime !== 0 && activeCommand !== "") {
                var duration = (Date.now() - pressStartTime);
                console.log(activeCommand + " button released after ~" + duration + " ms.");
                pressStartTime = 0;
                activeCommand = "";
            }

            var logMsg = isManualPress ? "STOP (Manual Button Press)" : "STOP (Preset Timer Finished)";
            console.log("Sent: " + logMsg);

            // --- Use RPC POST request ---
            fetch('/rpc/Bed.Command', {
                method: 'POST',
                headers: { 'ContentType': 'application/json' },
                body: JSON.stringify({ cmd: 'STOP' }) // Always send STOP to stop motors
            })
            .then(function(response) { return response.json(); })
            .then(function(status) {
                let result = status.result || status; // Handle nested result
                console.log("Received status update:", JSON.stringify(result));
                updateStatusDisplay(result.bootTime, result.uptime, result.headPos, result.footPos);
            })
            .catch(function(error) {
                console.error("Fetch error for STOP:", error);
            });
        }

        // --- Status Polling Function ---
        function pollStatus() {
            fetch('/rpc/Bed.Status', { // Use the new, safe STATUS endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}) // No args needed
            })
            .then(function(response) {
                if (!response.ok) {
                    // Don't log 404 for favicon
                    if (response.status !== 404) {
                        console.error('Poll status: ' + response.statusText);
                    }
                    throw new Error('Poll response was not ok');
                }
                return response.json();
            })
            .then(function(status) {
                let result = status.result || status; // Handle nested result
                // Only update if the response is valid
                if (result && result.bootTime) {
                    updateStatusDisplay(result.bootTime, result.uptime, result.headPos, result.footPos);
                }
            })
            .catch(function(error) {
                // Don't log the "not ok" error again
                if (error.message !== 'Poll response was not ok') {
                    console.error("Poll error:", error);
                }
            });
        }

        // --- Start Polling ---
        // Poll immediately on load, then every 1 second
        try {
            pollStatus(); 
            setInterval(pollStatus, 1000); // <-- CHANGED to 1000ms
        } catch (e) {
            console.error("Failed to start polling:", e);
        }

    </script>
</body>
</html>