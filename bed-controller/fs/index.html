<!DOCTYPE html>
<html>
<head>
    <title>Bed Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 400px;
        }
        h1 {
            text-align: center;
            color: #e5e7eb; /* gray-200 */
            margin-bottom: 20px;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px 10px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: white;
        }
        button i {
            font-size: 1.1em;
        }
        button:active {
            transform: scale(0.97);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        .control-btn { background-color: #3b82f6; } /* blue-500 */
        .control-btn:hover { background-color: #2563eb; } /* blue-600 */
        
        .stop-btn { background-color: #ef4444; } /* red-500 */
        .stop-btn:hover { background-color: #dc2626; } /* red-600 */
        
        .preset-btn { background-color: #f59e0b; } /* amber-500 */
        .preset-btn:hover { background-color: #d97706; } /* amber-600 */
        
        /* --- NEW: Style for running preset button --- */
        .preset-btn.btn-running {
            background-color: #e11d48; /* rose-600 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* --- END NEW --- */

        .all-btn { background-color: #10b981; } /* emerald-500 */
        .all-btn:hover { background-color: #059669; } /* emerald-600 */
        
        .light-btn { background-color: #8b5cf6; } /* violet-500 */
        .light-btn:hover { background-color: #7c3aed; } /* violet-600 */
        
        .status {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #a1a1aa; /* zinc-400 */
            /* Fixed height to prevent layout shift */
            height: 40px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .status-line {
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-bed"></i> Bed Control</h1>
        <div class="btn-group">
            <!-- Row 1: Head -->
            <div class="row">
                <button class="control-btn" ontouchstart="sendCmd('HEAD_UP')" ontouchend="stopCmd(true)" onmousedown="sendCmd('HEAD_UP')" onmouseup="stopCmd(true)">
                    <i class="fas fa-arrow-up"></i> Head Up
                </button>
                <button class="control-btn" ontouchstart="sendCmd('HEAD_DOWN')" ontouchend="stopCmd(true)" onmousedown="sendCmd('HEAD_DOWN')" onmouseup="stopCmd(true)">
                    <i class="fas fa-arrow-down"></i> Head Down
                </button>
            </div>
            
            <!-- Row 2: Foot -->
            <div class="row">
                <button class="control-btn" ontouchstart="sendCmd('FOOT_UP')" ontouchend="stopCmd(true)" onmousedown="sendCmd('FOOT_UP')" onmouseup="stopCmd(true)">
                    <i class="fas fa-arrow-up"></i> Foot Up
                </button>
                <button class="control-btn" ontouchstart="sendCmd('FOOT_DOWN')" ontouchend="stopCmd(true)" onmousedown="sendCmd('FOOT_DOWN')" onmouseup="stopCmd(true)">
                    <i class="fas fa-arrow-down"></i> Foot Down
                </button>
            </div>
            
            <!-- Row 3: All -->
            <div class="row">
                <button class="all-btn" ontouchstart="sendCmd('ALL_UP')" ontouchend="stopCmd(true)" onmousedown="sendCmd('ALL_UP')" onmouseup="stopCmd(true)">
                    <i class="fas fa-angles-up"></i> All Up
                </button>
                <button class="all-btn" ontouchstart="sendCmd('ALL_DOWN')" ontouchend="stopCmd(true)" onmousedown="sendCmd('ALL_DOWN')" onmouseup="stopCmd(true)">
                    <i class="fas fa-angles-down"></i> All Down
                </button>
            </div>
            
            <!-- Row 4: Stop -->
            <div class="row">
                <button class="stop-btn" style="flex-grow: 2;" onclick="stopCmd(true)">
                    <i class="fas fa-stop-circle"></i> STOP ALL MOTORS
                </button>
            </div>
            
            <!-- Row 5: Light -->
            <div class="row">
                <button class="light-btn" style="flex-grow: 2;" onclick="sendCmd('LIGHT_TOGGLE')">
                    <i class="fas fa-lightbulb"></i> Toggle Light
                </button>
            </div>
            
            <!-- Row 6: Presets -->
            <div class="row">
                <button id="btn-flat" class="preset-btn" onclick="sendCmd('FLAT', this)">
                    <i class="fas fa-minus"></i> Flat
                </button>
                <button id="btn-zerog" class="preset-btn" onclick="sendCmd('ZERO_G', this)">
                    <i class="fas fa-rocket"></i> Zero G
                </button>
            </div>
            
            <!-- Row 7: Presets -->
            <div class="row">
                <button id="btn-snore" class="preset-btn" onclick="sendCmd('ANTI_SNORE', this)">
                    <i class="fas fa-book-open"></i> Anti-Snore
                </button>
                <button id="btn-legs" class="preset-btn" onclick="sendCmd('LEGS_UP', this)">
                    <i class="fas fa-person-rays"></i> Legs Up
                </button>
            </div>
        </div> <!-- end btn-group -->

        <!-- Status Line -->
        <div class="status">
            <div id="status-line-1" class="status-line">Connecting...</div>
            <div id="status-line-2" class="status-line"></div>
        </div>
        
    </div> <!-- end container -->
    
    <script>
        // --- Client-side JavaScript ---

        var pressStartTime = 0;
        var activeCommand = "";
        var presetTimerId = null; // Timer for preset final status check

        // --- NEW: Format boot timestamp ---
        // Converts a UNIX timestamp (in seconds) to "Nov 5, 8:30 PM"
        function formatBootTime(timestamp) {
            try {
                const date = new Date(timestamp * 1000);
                // Use undefined locale to get user's local format
                const options = {
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true
                };
                return date.toLocaleString(undefined, options);
            } catch (e) {
                console.error("Error formatting date:", e);
                return "Unknown";
            }
        }

        // --- MODIFIED: Update status display ---
        function updateStatusDisplay(bootTime, headPos, footPos) {
            var statusEl1 = document.getElementById("status-line-1");
            var statusEl2 = document.getElementById("status-line-2");
            if (statusEl1 && statusEl2) {
                // Format the boot time
                let formattedTime = formatBootTime(bootTime);
                statusEl1.textContent = "Up since: " + formattedTime;
                // Always show position
                statusEl2.textContent = "Pos H: " + headPos + "s | Pos F: " + footPos + "s";
            }
        }

        // --- NEW: Helper to clear all running preset buttons ---
        function clearRunningPresets() {
            var allPresets = document.querySelectorAll('.preset-btn.btn-running');
            for (var i = 0; i < allPresets.length; i++) {
                allPresets[i].classList.remove('btn-running');
            }
        }

        // --- MODIFIED: Send RPC Command ---
        function sendCmd(cmd, btnElement) {
            console.log("Sent: " + cmd);

            // This is a momentary (hold-down) button
            if (cmd !== "STOP" && cmd !== "LIGHT_TOGGLE" && !cmd.startsWith('FLAT') && !cmd.startsWith('ZERO_G') && !cmd.startsWith('ANTI_SNORE') && !cmd.startsWith('LEGS_UP')) {
                pressStartTime = Date.now();
                activeCommand = cmd;
            }

            // This is a preset (one-click) button
            if (btnElement) {
                clearRunningPresets(); // Clear any other running presets
                btnElement.classList.add('btn-running'); // Set this one as running
            }
            
            // --- NEW: Use RPC POST request ---
            fetch('/rpc/Bed.Command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cmd: cmd })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(function(status) {
                // Mongoose OS RPC wraps the actual return value in a "result" object
                let result = status.result || status;
                console.log("Received immediate status:", JSON.stringify(result));
                updateStatusDisplay(result.bootTime, result.headPos, result.footPos);

                // If this was a preset, set a timer to fetch final status
                if (cmd === "ZERO_G" || cmd === "FLAT" || cmd === "ANTI_SNORE" || cmd === "LEGS_UP") {
                    var maxWait = parseInt(result.maxWait) || 0;
                    if (maxWait > 0) {
                        // Use server-provided time + 1.5s buffer
                        var waitMs = maxWait + 1500;
                        console.log(cmd + ": Setting timer to fetch final status in " + (waitMs / 1000) + "s");
                        
                        // Clear any old timer before setting a new one
                        if (presetTimerId) clearTimeout(presetTimerId);
                        
                        presetTimerId = setTimeout(function() {
                            stopCmd(false); // Call stopCmd to fetch status (not a manual press)
                        }, waitMs);
                    } else {
                        // No movement, just clear the button
                        clearRunningPresets();
                    }
                }
            })
            .catch(function(error) {
                console.error("Fetch error for " + cmd + ":", error);
                clearRunningPresets(); // Stop pulsing on error
            });
        }

        // --- MODIFIED: Stop Command / Status Fetch ---
        function stopCmd(isManualPress) {
            // Clear any pending preset timer
            if (presetTimerId) {
                let timerToClear = presetTimerId;
                clearTimeout(presetTimerId);
                presetTimerId = null;
                console.log("Clearing preset timer (" + timerToClear + ") due to STOP command.");
            }
            // Clear all pulsing buttons
            clearRunningPresets();

            if (pressStartTime !== 0 && activeCommand !== "") {
                var duration = (Date.now() - pressStartTime);
                console.log(activeCommand + " button released after ~" + duration + " ms.");
                pressStartTime = 0;
                activeCommand = "";
            }

            var logMsg = isManualPress ? "STOP (Manual Button Press)" : "STOP (Preset Timer Finished)";
            console.log("Sent: " + logMsg);

            // --- NEW: Use RPC POST request ---
            fetch('/rpc/Bed.Command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cmd: 'STOP' }) // Always send STOP to stop motors
            })
            .then(function(response) { return response.json(); })
            .then(function(status) {
                let result = status.result || status; // Handle nested result
                console.log("Received status update:", JSON.stringify(result));
                updateStatusDisplay(result.bootTime, result.headPos, result.footPos);
            })
            .catch(function(error) {
                console.error("Fetch error for STOP:", error);
            });
        }

        // --- NEW: Status Polling Function ---
        function pollStatus() {
            fetch('/rpc/Bed.Status', { // Use the new, safe STATUS endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}) // No args needed
            })
            .then(function(response) {
                if (!response.ok) {
                    // Don't log 404 for favicon
                    if (response.status !== 404) {
                        console.error('Poll status: ' + response.statusText);
                    }
                    throw new Error('Poll response was not ok');
                }
                return response.json();
            })
            .then(function(status) {
                let result = status.result || status; // Handle nested result
                // Only update if the response is valid
                if (result && result.bootTime) {
                    updateStatusDisplay(result.bootTime, result.headPos, result.footPos);
                }
            })
            .catch(function(error) {
                // Don't log the "not ok" error again
                if (error.message !== 'Poll response was not ok') {
                    console.error("Poll error:", error);
                }
            });
        }

        // --- Start Polling ---
        // Poll immediately on load, then every 2 seconds
        // Wrap in a try-catch in case pollStatus itself has a syntax error
        try {
            pollStatus(); 
            setInterval(pollStatus, 2000); 
        } catch (e) {
            console.error("Failed to start polling:", e);
        }

    </script>
</body>
</html>