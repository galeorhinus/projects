<!DOCTYPE html>
<html>
<head>
    <title>Wi-Fi Provisioning</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg viewBox="0 0 48 40" width="48" height="40">
                <path d="M13 14 V26 H16 V21 H22.5 V32 H25.5 V21 H32 V26 H35 V14 H32 V18 H16 V14 Z" fill="#38bdf8"/>
            </svg>
        </div>
        <h1>Wi-Fi Provisioning</h1>
        <div id="wifi-form">
            <p>Select a Wi-Fi network:</p>
            <select id="ssid">
                <option>Loading...</option>
            </select><br>
            <button onclick="scanWifi()" style="margin-top: 10px;">Scan for Networks</button>
            <p>Password:</p>
            <input type="password" id="password">
            <button onclick="connect()">Connect</button>
            <button onclick="resetWifi()" style="background-color:#555; margin-top: 10px;">Reset Wi-Fi</button>
        </div>
        <div id="status"></div>
    </div>
    <script>
        let statusInterval;

        function fetchStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('status');
                    if (data.state === 'connected') {
                        const url = `http://${data.mdns}.local`;
                        statusDiv.innerHTML = `Successfully connected to Wi-Fi!<br>IP: ${data.ip}<br>You can now access the device at <a href="${url}" target="_blank">${data.mdns}.local</a>.`
                            + `<br><br><button onclick="copyUrl('${url}')">Copy URL</button> <button onclick="resetWifi()">Reset Wi-Fi</button> <button onclick="closeAp()">Close</button>`;
                        clearInterval(statusInterval);
                    } else if (data.state === 'error') {
                        statusDiv.innerText = `Connection failed: ${data.reason || 'Unknown error'}`;
                        clearInterval(statusInterval);
                    } else {
                        statusDiv.innerText = 'Connecting...';
                    }
                });
        }

        function connect() {
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('status');
            statusDiv.innerText = 'Connecting...';

            fetch('/wifi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ssid, password })
            }).then(() => {
                statusInterval = setInterval(fetchStatus, 2000);
            });
        }

        function resetWifi() {
            if (confirm('Are you sure you want to reset Wi-Fi settings and restart the device?')) {
                fetch('/reset_wifi', { method: 'POST' })
                    .then(() => {
                        document.getElementById('status').innerText = 'Wi-Fi settings reset. Restarting...';
                        setTimeout(() => window.location.reload(), 3000);
                    });
            }
        }

        function scanWifi() {
            const ssidSelect = document.getElementById('ssid');
            ssidSelect.innerHTML = '<option>Scanning...</option>';
            fetch('/scan')
                .then(response => response.json())
                .then(networks => {
                    ssidSelect.innerHTML = '';
                    networks.sort((a, b) => b.rssi - a.rssi);
                    networks.forEach(net => {
                        const option = document.createElement('option');
                        option.value = net.ssid;
                        option.innerText = `${net.ssid} (${net.rssi}dBm)`;
                        ssidSelect.appendChild(option);
                    });
                });
        }

        window.onload = scanWifi;

        function closeAp() {
            fetch('/close_ap', { method: 'POST' })
                .then(() => document.getElementById('status').innerText = 'Access point closed.');
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url)
                .then(() => alert('URL copied to clipboard!'));
        }
    </script>
</body>
</html>