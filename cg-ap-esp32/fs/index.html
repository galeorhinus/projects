<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bed Controller • Setup</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0b1220; color:#e6eefb; }
    .wrap { max-width: 560px; margin: 6vh auto; padding: 24px; background:#121b2e; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    h1 { margin: 0 0 8px; font-size: 24px; }
    p { opacity:.85; line-height:1.5 }
    label { display:block; margin: 16px 0 6px; opacity:.9 }
    input, button { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #27324a; background:#0e1627; color:#e6eefb; }
    input:focus { outline: none; border-color:#3a71ff; box-shadow: 0 0 0 3px rgba(58,113,255,.2); }
    button { cursor:pointer; background:#3a71ff; border:0; margin-top:16px; font-weight:600; }
    button.sec { background:#1e2740; border:1px solid #27324a; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1 }
    .msg { margin-top: 16px; padding: 12px; background:#0e1627; border:1px solid #27324a; border-radius:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space:pre-wrap; }
    .ok { border-color:#2d7d46; }
    .err { border-color:#a04343; }
    .hidden { display:none; }
    .center { text-align:center; }
    .small { opacity:.75; font-size: 13px; }
    .actions { display:flex; gap:10px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bed Controller • Setup</h1>
    <p>Connect the device to your Wi-Fi network.</p>

    <!-- Setup form -->
    <div id="formCard">
      <label for="ssid">Wi-Fi network</label>
      <input id="ssid" placeholder="MyHomeWiFi" autocomplete="off" />

      <label for="pass">Password</label>
      <input id="pass" type="password" placeholder="••••••••" />

      <button id="saveBtn">Save & Reboot</button>
      <div class="msg" id="log"><span class="small">Ready.</span></div>
    </div>

    <!-- Post-save / reboot guidance -->
    <div id="handoffCard" class="hidden">
      <h2 class="small" style="margin:0 0 8px">Device is switching to your Wi-Fi…</h2>
      <div class="msg" id="handoffMsg">Saving…</div>
      <div class="actions">
        <button id="tryMdnsBtn" class="sec">Try bedcontroller.local</button>
        <button id="advancedBtn" class="sec">Advanced…</button>
      </div>

      <div id="advancedBox" class="hidden">
        <p class="small" style="margin-top:10px">If the name <code>bedcontroller.local</code> doesn’t work on your network, enter the device IP assigned by your router:</p>
        <div class="row">
          <input id="manualIp" placeholder="e.g. 192.168.0.13" />
          <button id="openIpBtn" class="sec" style="flex:0 0 140px;">Open App</button>
        </div>
        <p class="small">Tip: On a Mac you can also try: <code>ping bedcontroller.local</code> or check your router’s DHCP clients list.</p>
      </div>
    </div>
  </div>


  <script>
    const logEl = document.getElementById('log');
    const ssidEl = document.getElementById('ssid');
    const passEl = document.getElementById('pass');
    const scanBtn = document.getElementById('scanBtn');
    const saveBtn = document.getElementById('saveBtn');
    
    function log(line, cls) {
      if (cls) logEl.className = 'msg ' + cls;
      logEl.textContent = line;
    }
    
    // JSON-RPC helper over the Mongoose OS HTTP bridge
    async function rpc(method, args = {}) {
      const res = await fetch('/rpc/' + method, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(args)
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`RPC ${method} HTTP ${res.status}: ${t}`);
      }
      return res.json().catch(()=> ({}));
    }
    
    scanBtn.onclick = async () => {
      log('Scanning Wi-Fi…');
      try {
        const list = await rpc('WiFi.Scan', {});
        if (Array.isArray(list)) {
          const ssids = [...new Set(list.map(x => x.ssid).filter(Boolean))].slice(0, 30);
          if (ssids.length) {
            const pick = prompt('Select SSID (or type manually):\n' + ssids.join('\n'));
            if (pick) ssidEl.value = pick;
            log('Scan complete.');
          } else {
            log('No networks found. Enter SSID manually.', 'err');
          }
        } else {
          log('Unexpected scan result. Enter SSID manually.', 'err');
        }
      } catch (e) {
        log('Scan failed: ' + e.message, 'err');
      }
    };
    
    // Poll STA status until we have an IP, then show link
    async function waitForStaIP(timeoutMs = 60000) {
      const started = Date.now();
      while (Date.now() - started < timeoutMs) {
        try {
          const st = await rpc('WiFi.GetStatus', {});
          // Typical fields: { wifi: { sta_ip: "192.168.x.y", ... } } or sometimes flat
          const ip = (st && st.sta_ip) || (st && st.wifi && st.wifi.sta_ip) || '';
          if (ip && ip !== '0.0.0.0') return ip;
        } catch (_) {}
        await new Promise(r => setTimeout(r, 1000));
      }
      throw new Error('Timed out waiting for STA IP');
    }
    
    saveBtn.onclick = async () => {
      const ssid = ssidEl.value.trim();
      const pass = passEl.value;
    
      if (!ssid) { log('Please enter SSID.', 'err'); return; }
    
      log('Saving Wi-Fi (keeping setup AP active)…');
      try {
        // 1) Enable STA with creds AND keep AP enabled; save persistently
        await rpc('Config.Set', {
          config: { wifi: { sta: { enable: true, ssid, pass }, ap: { enable: true } } },
          save: true
        });
    
        // 2) (Optional) Nudge Wi-Fi to re-evaluate config immediately
        // Not all builds have this. If it fails, polling still usually works.
        try { await rpc('WiFi.Reconnect', {}); } catch (_) {}
    
        log('Connecting to your Wi-Fi… (AP stays up so we can show the IP)');
        const ip = await waitForStaIP(60000);
    
        log(`Connected! Device IP on your network: ${ip}\n` +
            `Open: http://${ip}/app.html\n\n` +
            `When you’re ready, click “Finish” to turn off setup Wi-Fi (AP) and reboot.`,
            'ok');
    
        // Add a Finish button dynamically (in case HTML didn’t have one)
        let finishBtn = document.getElementById('finishBtn');
        if (!finishBtn) {
          finishBtn = document.createElement('button');
          finishBtn.id = 'finishBtn';
          finishBtn.textContent = 'Finish (Disable AP & Reboot)';
          finishBtn.style.marginTop = '12px';
          finishBtn.onclick = async () => {
            try {
              log('Disabling setup AP and rebooting…');
              await rpc('Config.Set', {
                config: { wifi: { ap: { enable: false } } },
                save: true
              });
              await rpc('Sys.Reboot', {});
            } catch (e) {
              log('Failed: ' + e.message, 'err');
            }
          };
          logEl.insertAdjacentElement('afterend', finishBtn);
        }
    
        // Also render a clickable link to the app
        let link = document.getElementById('appLink');
        if (!link) {
          link = document.createElement('p');
          link.id = 'appLink';
          link.innerHTML = `<a href="http://${ip}/app.html" target="_blank" rel="noopener">Open app at http://${ip}/app.html</a>`;
          logEl.insertAdjacentElement('afterend', link);
        }
    
      } catch (e) {
        log('Save/connect failed: ' + e.message + '\nCheck SSID/password and try again.', 'err');
      }
    };
    </script>
    
</body>
</html>
